# üîç Production E-Commerce System ‚Äî Comprehensive Investigation Report

**Date:** 2026-02-28  
**Environment:** Production (`kvastram-ecommerce.vercel.app` + `kvastram-backend-production.up.railway.app`)  
**Investigator:** Automated E2E Testing + Code Analysis + Live API Testing

---

## Executive Summary

The production system has **8 confirmed bugs** across 3 severity levels. The primary root cause is that **recent code fixes have NOT been deployed** ‚Äî the production deployment still runs the old codebase. Additionally, critical environment variables contain placeholder values, and the SMTP email service is non-functional.

> [!CAUTION]
> **None of the local code fixes from this session have been deployed to production yet.** The storefront, backend, and admin panel all need redeployment.

---

## üß™ Live API Test Results

| Endpoint            | Method | Status     | Response                                          |
| ------------------- | ------ | ---------- | ------------------------------------------------- |
| `/` (root)          | GET    | ‚úÖ 200     | `"Welcome to Kvastram API"`                       |
| `/products?limit=1` | GET    | ‚úÖ 200     | Returns products with pagination                  |
| `/regions`          | GET    | ‚úÖ 200     | Returns 23 regions (many duplicates)              |
| `/store/settings`   | GET    | ‚ùå **404** | Route does not exist in production                |
| `/store/auth/login` | GET    | ‚ùå **404** | (Expected ‚Äî POST only, but confirms route exists) |

---

## üêõ Bug Report ‚Äî Confirmed Issues

### BUG-001: Registration AbortError (CRITICAL)

- **Symptom:** Registration shows `"signal is aborted without reason"` error to user
- **Reality:** The registration actually SUCCEEDS on the backend ‚Äî the user IS created. But the 15s client-side timeout fires before the backend responds (registration involves bcrypt hashing + email sending which takes >15s with broken SMTP)
- **Root Cause:** Backend registration calls `emailService.sendVerificationEmail()` which hangs for 10s (SMTP connection timeout), making total response time >15s. Client `AbortController` cuts the connection
- **Affected Files:**
  - [storefront/src/lib/api.ts](file:///e:/Kvastram%20projects/kvastram-platform/storefront/src/lib/api.ts) ‚Äî [fetchWithTrace](file:///e:/Kvastram%20projects/kvastram-platform/storefront/src/lib/api.ts#37-80) timeout
  - [backend/src/services/customer-auth-service.ts](file:///e:/Kvastram%20projects/kvastram-platform/backend/src/services/customer-auth-service.ts#L238-L250) ‚Äî [register()](file:///e:/Kvastram%20projects/kvastram-platform/backend/src/services/customer-auth-service.ts#169-255) awaits email
- **Fix Status:** ‚ö†Ô∏è Timeout increased to 15s locally but NOT deployed. The SMTP email service also needs real credentials.

### BUG-002: Login Blocked by Email Verification (HIGH)

- **Symptom:** Login returns `401 "Please verify your email before logging in"`
- **Root Cause:** Email verification is required before login, but verification emails never arrive (SMTP credentials are placeholders: `smtp.mailtrap.io` / `your_mailtrap_username`)
- **Catch-22:** Users register ‚Üí can't verify email (no email arrives) ‚Üí can't login ‚Üí stuck
- **Evidence:** Live test confirmed: registration succeeds, login returns 401 with verification message
- **Fix Required:** Configure real SMTP credentials in Railway environment variables

### BUG-003: Forgot Password Timeout (CRITICAL)

- **Symptom:** Forgot password page hangs for 30+ seconds, then shows timeout error
- **Root Cause (Production):** The deployed code still calls the backend directly via `NEXT_PUBLIC_API_URL` (which is `https://your-backend.railway.app` ‚Äî a placeholder!) instead of using the `/api/` proxy
- **Root Cause (Backend):** Even with correct routing, the SMTP email send hangs for 10s before timing out, causing the endpoint to hit the 30s server timeout
- **Evidence:** Browser test confirmed 408 timeout after 30s hang
- **Fix Status:** ‚ö†Ô∏è Fixed locally (now uses `/api/store/auth/forgot-password` proxy) but NOT deployed

### BUG-004: `/store/settings` Returns 404 (HIGH)

- **Symptom:** Every page load triggers a 404 for `/api/store/settings`
- **Impact:** Cart icon visibility, currency defaults, free shipping threshold, and tax rates all fall back to hardcoded defaults
- **Root Cause:** The `/store/settings` route was created locally (new file [backend/src/routes/store/settings.ts](file:///e:/Kvastram%20projects/kvastram-platform/backend/src/routes/store/settings.ts)) but has NOT been deployed
- **Evidence:** `GET https://kvastram-backend-production.up.railway.app/store/settings` returns 404

### BUG-005: Cart Prices Multiplied by 100x (HIGH)

- **Symptom:** Silk Scarf shows **$4,500.00** instead of **$45.00**. Free shipping message says "Add $20,500.00 more"
- **Root Cause:** Product prices stored in cents in the database (4500 = $45.00), but [formatCartPrice](file:///e:/Kvastram%20projects/kvastram-platform/storefront/src/app/cart/page.tsx#89-96) uses `Intl.NumberFormat` which treats the value as whole dollars. The `free_shipping_threshold` default is `25000` (should be `250` or `25000` if in cents)
- **Evidence:** Cart screenshot shows $4,500.00 for Silk Scarf, "Add $20,500.00 more for free shipping!"

```carousel
![Cart page showing inflated prices ‚Äî $4,500.00 for Silk Scarf and $20,500.00 free shipping threshold](C:\Users\User\.gemini\antigravity\brain\268a301f-f6e1-4fe0-984a-d6b762661a2b\.system_generated\click_feedback\click_feedback_1772289113230.png)
<!-- slide -->
![Product page showing Silk Scarf at $45.00 ‚Äî correct price on product page](C:\Users\User\.gemini\antigravity\brain\268a301f-f6e1-4fe0-984a-d6b762661a2b\.system_generated\click_feedback\click_feedback_1772289071691.png)
```

- **Fix Required:** ~~Divide prices by 100 in [formatCartPrice](file:///e:/Kvastram%20projects/kvastram-platform/storefront/src/app/cart/page.tsx#89-96)~~ ‚úÖ **FIXED** ‚Äî both [cart/page.tsx](file:///e:/Kvastram%20projects/kvastram-platform/storefront/src/app/cart/page.tsx) and [MiniCart.tsx](file:///e:/Kvastram%20projects/kvastram-platform/storefront/src/components/cart/MiniCart.tsx) now use `amount / 100`
- **Affected Files:** [cart/page.tsx:89-95](file:///e:/Kvastram%20projects/kvastram-platform/storefront/src/app/cart/page.tsx#L89-L95), [MiniCart.tsx:44-50](file:///e:/Kvastram%20projects/kvastram-platform/storefront/src/components/cart/MiniCart.tsx#L44-L50)

### BUG-006: SMTP Email Service Non-Functional (CRITICAL)

- **Symptom:** No emails are ever sent (verification, password reset, order confirmation)
- **Root Cause:** Production SMTP uses placeholder credentials:
  ```
  SMTP_HOST=smtp.mailtrap.io
  SMTP_USER=your_mailtrap_username
  SMTP_PASS=your_mailtrap_password
  ```
- **Impact:** Blocks ALL email-dependent flows (registration verification, password reset, order notifications)
- **Fix Required:** Set real SMTP credentials in Railway dashboard

### BUG-007: [.env.production](file:///e:/Kvastram%20projects/kvastram-platform/storefront/.env.production) Contains Placeholder URLs (CRITICAL)

- **Symptom:** SSR API calls fail or go to wrong server
- **Root Cause:** The [.env.production](file:///e:/Kvastram%20projects/kvastram-platform/storefront/.env.production) file contains:
  ```
  NEXT_PUBLIC_API_URL=https://your-backend.railway.app  ‚Üê PLACEHOLDER!
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_your_stripe_publishable_key  ‚Üê PLACEHOLDER!
  ```
- **Impact:** Server-side rendered pages can't fetch data; Stripe checkout won't work
- **Note:** Client-side calls work because [api.ts](file:///e:/Kvastram%20projects/kvastram-platform/admin/src/lib/api.ts) uses `/api` (relative) for browser requests, but SSR uses the env var directly

### BUG-008: CORS/ALLOWED_ORIGINS Misconfigured (MEDIUM)

- **Symptom:** Potential CORS errors when the real domain is used
- **Root Cause:** The [render.yaml](file:///e:/Kvastram%20projects/kvastram-platform/render.yaml) has `ALLOWED_ORIGINS=https://your-storefront.vercel.app,https://your-admin.vercel.app` ‚Äî placeholders that don't match the actual Vercel deployment URLs
- **Actual URLs:** storefront is `kvastram-ecommerce.vercel.app`, admin URL unknown
- **Fix Required:** Update `ALLOWED_ORIGINS` in Railway to include actual Vercel deployment URLs

---

## üîß Email Service Verification

### XSS Vulnerability Patches ‚úÖ

```diff
+ function escapeHtml(str: string): string { ... }  // Implemented
+ function safeString(str, fallback): string { ... }  // Implemented
+ function formatCurrency(total, currency): string { ... }  // Implemented
```

All three helper functions are present in [email-service.ts](file:///e:/Kvastram%20projects/kvastram-platform/backend/src/services/email-service.ts#L4-L23). XSS patches verified.

### Email Service Configuration ‚úÖ (Code) / ‚ùå (Production)

- **Code:** Correctly reads from `process.env.SMTP_*` with 10s timeout settings
- **Production:** Uses placeholder credentials ‚Äî emails will fail silently

### Regression Check

- [escapeHtml()](file:///e:/Kvastram%20projects/kvastram-platform/backend/src/services/email-service.ts#3-12) properly escapes `&`, `<`, `>`, `"`, `'` ‚Äî no regression
- [safeString()](file:///e:/Kvastram%20projects/kvastram-platform/backend/src/services/email-service.ts#13-17) uses [escapeHtml](file:///e:/Kvastram%20projects/kvastram-platform/backend/src/services/email-service.ts#3-12) with fallback ‚Äî no regression
- [formatCurrency()](file:///e:/Kvastram%20projects/kvastram-platform/backend/src/services/email-service.ts#18-24) handles cents vs dollars ‚Äî no regression
- Connection timeouts (10s) prevent infinite hanging ‚Äî improvement verified

---

## üìä Deployment Gap Analysis

| Fix                         | Local Code | Production      |
| --------------------------- | ---------- | --------------- |
| API timeout 5s ‚Üí 15s        | ‚úÖ Applied | ‚ùå Not deployed |
| Forgot-password proxy fix   | ‚úÖ Applied | ‚ùå Not deployed |
| Reset-password proxy fix    | ‚úÖ Applied | ‚ùå Not deployed |
| Verify-email proxy fix      | ‚úÖ Applied | ‚ùå Not deployed |
| Contact form proxy fix      | ‚úÖ Applied | ‚ùå Not deployed |
| Wholesale form proxy fix    | ‚úÖ Applied | ‚ùå Not deployed |
| Newsletter proxy fix        | ‚úÖ Applied | ‚ùå Not deployed |
| `/store/settings` route     | ‚úÖ Created | ‚ùå Not deployed |
| Free shipping threshold fix | ‚úÖ Applied | ‚ùå Not deployed |
| Cart price `/ 100` fix      | ‚úÖ Applied | ‚ùå Not deployed |
| MiniCart price `/ 100` fix  | ‚úÖ Applied | ‚ùå Not deployed |
| Login lockout fix           | ‚úÖ Applied | ‚ùå Not deployed |
| `metadata` TS errors fix    | ‚úÖ Applied | ‚ùå Not deployed |

---

## üöÄ Required Actions (Priority Order)

### 1. Deploy Code Changes (IMMEDIATE)

```bash
# Push all local changes to git
git add -A
git commit -m "fix: production critical fixes - proxy routing, settings, timeouts"
git push origin main
```

This triggers automatic deployment on Vercel (storefront) and Railway (backend).

### 2. Set Production Environment Variables (IMMEDIATE)

**Railway (Backend):**
| Variable | Current Value | Required Value |
|----------|--------------|----------------|
| `ALLOWED_ORIGINS` | `https://your-storefront.vercel.app,...` | `https://kvastram-ecommerce.vercel.app,https://YOUR-ADMIN.vercel.app` |
| `FRONTEND_URL` | `https://your-storefront.vercel.app` | `https://kvastram-ecommerce.vercel.app` |
| `SMTP_HOST` | `smtp.mailtrap.io` | Real SMTP host (e.g., `smtp.gmail.com`) |
| `SMTP_USER` | `your_mailtrap_username` | Real SMTP username |
| `SMTP_PASS` | `your_mailtrap_password` | Real SMTP password |

**Vercel (Storefront):**
| Variable | Current Value | Required Value |
|----------|--------------|----------------|
| `NEXT_PUBLIC_API_URL` | `https://your-backend.railway.app` | `https://kvastram-backend-production.up.railway.app` |
| `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` | `pk_test_your_stripe_...` | Real Stripe publishable key |

### 3. Fix Cart Price Display (CODE CHANGE)

The cart page needs `/ 100` when prices are in cents:

```typescript
// cart/page.tsx line 89
const formatCartPrice = (amount: number) => {
  const currency = currentRegion?.currency_code?.toUpperCase() || "USD";
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency,
  }).format(amount / 100); // ‚Üê divide by 100 if prices are in cents
};
```

### 4. Clean Up Duplicate Regions (DATABASE)

The `/regions` endpoint returns 23 regions with 15+ duplicate "North America" entries. These should be cleaned up via the admin panel or direct database query.

---

## üì∏ Evidence Screenshots

```carousel
![Registration form filled and ready to submit](C:\Users\User\.gemini\antigravity\brain\268a301f-f6e1-4fe0-984a-d6b762661a2b\.system_generated\click_feedback\click_feedback_1772289240149.png)
<!-- slide -->
![Login page with credentials entered](C:\Users\User\.gemini\antigravity\brain\268a301f-f6e1-4fe0-984a-d6b762661a2b\.system_generated\click_feedback\click_feedback_1772289291184.png)
<!-- slide -->
![Forgot password page with email entered](C:\Users\User\.gemini\antigravity\brain\268a301f-f6e1-4fe0-984a-d6b762661a2b\.system_generated\click_feedback\click_feedback_1772289389162.png)
<!-- slide -->
![Cart page showing 100x price inflation bug](C:\Users\User\.gemini\antigravity\brain\268a301f-f6e1-4fe0-984a-d6b762661a2b\.system_generated\click_feedback\click_feedback_1772289113230.png)
<!-- slide -->
![Product detail page with correct $45.00 price](C:\Users\User\.gemini\antigravity\brain\268a301f-f6e1-4fe0-984a-d6b762661a2b\.system_generated\click_feedback\click_feedback_1772289071691.png)
```

![Browser test recording](C:\Users\User.gemini\antigravity\brain\268a301f-f6e1-4fe0-984a-d6b762661a2b\auth_flow_test_1772289200398.webp)
